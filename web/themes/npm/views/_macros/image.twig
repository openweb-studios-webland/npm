{# Join classes #}
{% macro classes(classes) %}
  {%- if (classes | length) -%}
    class="{{ classes | join(' ') }}"
  {%- endif -%}
{% endmacro %}

{# Create a variable width responsive image #}
{% macro responsive(imageId, imageWidth, imageHeight = null, classes = []) %}
    {# Get the asset meta data from WP #}
    {% set imageArray = function('wp_get_attachment_image_src', imageId, 'full') %}
    {% set imageSrc = imageArray[0] %}
    {% set imageAlt = function('get_post_meta', imageId, '_wp_attachment_image_alt', true) %}
    {% set imageMetaData = function('wp_get_attachment_metadata', imageId) %}
    {% set imageNativeWidth = imageMetaData.width %}
    {% set imageNativeHeight = imageMetaData.height %}
    {% set imageAspectRatio = imageNativeHeight / imageNativeWidth %}

    {% set srcsetWidths = [
      imageWidth * 0.4,
      imageWidth * 0.6,
      imageWidth * 0.8,
      imageWidth
    ] %}

    {% set imageHeight = imageHeight ?: imageWidth * imageAspectRatio %}

    {% set srcsetHeights = [
      imageHeight * 0.4,
      imageHeight * 0.6,
      imageHeight * 0.8,
      imageHeight
    ] %}

    {# Create the srcset array #}
    {% set imageSrcset = [] %}

    {% for srcsetWidth in srcsetWidths %}
      {% set imageSrcset = imageSrcset | merge([imageSrc | resize(srcsetWidth, srcsetHeights[loop.index0], 'center') ~ ' ' ~ srcsetWidth ~ 'w']) %}
    {% endfor %}

    <img
      src="{{ imageSrc | resize(imageWidth, imageHeight, 'center') }}"
      srcset="{{ imageSrcset | join(', ') }}"
      sizes="100vw"
      alt="{{ imageAlt }}"
      {{ _self.classes(classes) }}
    />
{% endmacro %}
